---
cmdline: "png-info"
title:  "Задача №2: Реализация на команда за извличане на информация от файл с формат png"
---
0. Условие на задачата

   0. Основна функционалност

      Целта на задачата е да се реализира командата `{{ page.cmdline }}`. Командата `{{ page.cmdline }}` приема един аргумент от командния ред - име на файл, който да се прочете, и печата върху стандартния изход информация за този файл. Трябва да се изведе информация за дължината и ширината на картинката.

      Ще имате на разположение функцията `void *read_file( const char *filepath )`, която, при подадено име на файл, ще изчете цялото съдържане в паметта, и ще върне като резултат указател към това съдържание.

      От съдъражението на файла ще трябва да извлечете дължината и ширината на картинката, която е записана в този файл.

      PNG форматът се състои от начална сигнатура, състояща се от последователността от байтове `89 50 4E 47 0D 0A 1A 0A`, и последователност от блокове (chunks).

      Един chunk има следния формат: chunk length (4 байта), chunk type (4 байта), chunk data (chunk length на брой байта), chunk crc (4 байта).

      Най-важене за един png файл е `IHDR` chunk-ът, чиито chunk type се състои от последователността от байтове `49 48 44 52` - това са ASCII символите `IHDR`. Данните (chunk data) на този блок се състоят от image width (4 байта), image height (4 байта) и още допълнителни полета. Вие трябва да изведете на екрана единствено тези две полета - дължината и ширината на картинката.

      Примерен изход от програмата:
      ```
      $ ./{{ page.cmdline }} sample.png
      PNG image width: 450
      PNG image height: 230
      ```

      Примерно съдържание на файл:
      ```
      00000000  89 50 4E 47 0D 0A 1A 0A  00 00 00 0D 49 48 44 52  |.PNG........IHDR|
      00000010  00 00 00 01 00 00 00 01  08 02 00 00 00 90 77 53  |..............wS|
      00000020  DE 00 00 00 0F 49 44 41  54 08 1D 01 04 00 FB FF  |.....IDAT.......|
      00000030  00 FF FF FF 05 FE 02 FE  03 7D 19 C6 00 00 00 00  |.........}......|
      00000040  49 45 4E 44 AE 42 60 82                           |IEND.B`.|
      00000048
      ```

      След началната сигнатура от 8 байта (`89 50 4E 47 0D 0A 1A 0A`) започва първият блок. Неговият размер е 13 байта (`00 00 00 0D`), a типът е `IHDR` (`49 48 44 52`). Следващите 4 байта показват дължината на картинката (`00 00 00 01`), а след тях е и ширината на картинката (`00 00 00 01`) - и дължината и ширината са по 1 пиксел. В този блок следват още 5 байта (13 - 8 = 5; `08 02 00 00 00`), чието съдържание не е от значение за правилно решаване на задачата. Блокът приключва с 4 байта за CRC (`90 77 53 DE`).

      Следва нов блок, чиито размер е 15 байта (`00 00 00 0F`), а типът е `IDAT` (`49 44 41 54`). Съдържанието (`08 1D 01 04 00 FB FF 00 FF FF FF 05 FE 02 FE`) отново не представлява интерес за задачата. И този блок приключва с 4 байта за CRC (`03 7D 19 C6`).

      Последният блок има дължина от 0 байта (`00 00 00 00`) и тип `IEND` (`49 45 4E 44`). Той също завършва със CRC (`AE 42 60 82`).

      Това е цялото съдържание на файла.

      Забележка 1: PNG е бинарен формат и всяко едно поле има точно определена дължина. Желателно е да използвате типа `uint32_t` (от заглавния файл `<stdint.h>`), който, независимо от хардуерната реализация, представлява 4 байтов целочислен тип за неотрицателни числа.

      Забележка 2: Всички числя във файла (chunk length, image width, image height) са в т. нар. network byte order, което означава, че числото 16 (десетично) се записва в паметта/изпраща по мрежата/записва във файл в следната последователност от байтове `00 00 00 10`. Но вашите компютри може да работят с числа подредени по друг начин (чисслото 16 може да е представен като `10 00 00 00`). За да се справите с този проблем, използвайте функцията `ntohl` (декларирана в заглавния файл `<arpa/inet.h>`), която конвертира от network byte order във формата, който използва вашата машина.

   0. Обработка на грешки

      Вашата програма трябва да може да се справи с различни видове грешки, които могат да настъпят по време на изпълнение.

      Функцията `read_file` ще върне `NULL`, когато не може да отвори и/или прочете зададения файл.

      Също така, вашата програма трябва да "не crash-ва", когато бъде подаден файл, чиито формат е различен от PNG.

      Примерен изход от програмата:
      ```
      $ ./{{ page.cmdline }} non-existing-file
      Unable to open file
      $ ./{{ page.cmdline }} sample.jpeg
      Unable to parse file
      ```


{% include requirements-cmd.md %}
